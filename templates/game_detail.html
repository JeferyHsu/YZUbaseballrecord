{% extends "base.html" %}
{% block content %}
<h2>
比數：{{ game.team_score }} ：{{ game.opponent_score }}<br>
<span style="font-size:1.2em;">元智大學 vs {{ game.opponent }}</span>
</h2>
<hr>

<h2>{{ game.date }} 的詳細打擊成績</h2>
<table border="1" cellpadding="4">
    <tr>
        <th>棒次</th>
        <th>球員</th>
        {% for inning in range(1, max_inning+1) %}
            <th>{{ inning }}</th>
        {% endfor %}
        <th>打數</th>
        <th>安打</th>
        <th>全壘打</th>
        <th>打點</th>
        <th>得分</th>
        <th>打擊率</th>
    </tr>
    {# 取得所有有出場的棒次(order)後分棒次分群 #}
    {% set orders = stats_table | map(attribute='order') | reject('equalto', "") | list | unique | sort %}
    {% for order in orders %}
        {% set group = stats_table | selectattr('order', 'equalto', order) | list %}
        {% for row in group %}
        <tr>
            <td>{% if loop.index0 == 0 %}{{ order + 1 }}{% endif %}</td>
            <td>{{ row.player.name }}<i>
                {% if row.note %}, {{ row.note }}{% endif %}
                {% if row.position %}, {{ row.position }}{% endif %}
            </i></td>
            {% for r in row.results %}
                <td>{{ r }}</td>
            {% endfor %}
            <td>{{ row.ab }}</td>
            <td>{{ row.hit }}</td>
            <td>{{ row.hr }}</td>
            <td>{{ row.rbi }}</td>
            <td>{{ row.run if row.run is defined else 0 }}</td>
            <td>
                {% if row.ab %}
                    {{ "%.3f" | format(row.hit / row.ab) }}
                {% else %}
                    0.000
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    {% endfor %}
    <tr style="background: #fff2d3;">
        <td>Total</td>
        <td></td>
        {% for t in total.inning_results %}
            <td>{{ t }}</td>
        {% endfor %}
        <td>{{ total.ab }}</td>
        <td>{{ total.hit }}</td>
        <td>{{ total.hr }}</td>
        <td>{{ total.rbi }}</td>
        <td>{{ total.run if total.run is defined else 0 }}</td>
        <td>-</td>
    </tr>
</table>
<hr>
<h2>投手成績</h2>
<table border="1" style="border-collapse: collapse;">
  <tr>
    <th>投手</th><th>投球局數</th><th>面對打席</th><th>投球數</th><th>好球數</th>
    <th>安打</th><th>全壘打</th><th>四壞</th><th>觸身</th><th>三振</th><th>失分</th>
  </tr>
  {% for p in pitcher_stats %}
  <tr>
    <td>{{ p.name }}</td>
    <td>{{ p.ip }}</td>
    <td>{{ p.batters }}</td>
    <td>{{ p.pitch_count }}</td>
    <td>{{ p.strikes }}</td>
    <td>{{ p.hits }}</td>
    <td>{{ p.hr }}</td>
    <td>{{ p.bb }}</td>
    <td>{{ p.hbp }}</td>
    <td>{{ p.k }}</td>
    <td>{{ p.run }}</td>
  </tr>
  {% endfor %}
  <tr style="background-color:#fdf4dc;font-weight:bold;">
    <td>總計</td>
    <td>{{ pitcher_total.ip }}</td>
    <td>{{ pitcher_total.batters }}</td>
    <td>{{ pitcher_total.pitch_count }}</td>
    <td>{{ pitcher_total.strikes }}</td>
    <td>{{ pitcher_total.hits }}</td>
    <td>{{ pitcher_total.hr }}</td>
    <td>{{ pitcher_total.bb }}</td>
    <td>{{ pitcher_total.hbp }}</td>
    <td>{{ pitcher_total.k }}</td>
    <td>{{ pitcher_total.run }}</td>
  </tr>
</table>

<h2>投手每局用球數</h2>
<table border="1">
    <tr>
        <th>投手</th>
        {% for inn in pitcher_innings %}
            <th>第{{ inn }}局</th>
        {% endfor %}
    </tr>
    {% for pitcher in pitcher_inning_data %}
    <tr>
        <td>{{ pitcher.name }}</td>
        {% for cnt in pitcher.data %}
            <td>{{ cnt }}</td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>

<h2>防守打席紀錄</h2>
<table border="1" style="border-collapse: collapse;">
    <tr>
      <th>局數</th>
      <th>投手</th>
      <th>對方打者</th>
      <th>好球</th>
      <th>壞球</th>
      <th>球數</th>
      <th>結果</th>
    </tr>
    {% for d in defense_records %}
    <tr>
      <td>{{ d.inning }}</td>
      <td>{{ d.pitcher.name if d.pitcher else '' }}</td>
      <td>{{ d.batter_name }}</td>
      <td>{{ d.strike }}</td>
      <td>{{ d.ball }}</td>
      <td>{{ d.pitch_count }}</td>
      <td>
          {% if d.result == 'RUNNER_OUT' %}
            跑者出局
          {% else %}
            {{ d.result }}
          {% endif %}
        </td>
    </tr>
    {% endfor %}
    <tr style="background-color:#fdf4dc;font-weight:bold;">
      <td colspan="5">Total</td>
      <td>{{ defense_records | sum(attribute='pitch_count') }}</td>
      <td>-</td>
    </tr>
</table>

<a href="{{ url_for('games') }}">返回歷史比賽</a>
{% endblock %}
