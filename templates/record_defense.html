{% extends "base.html" %}
{% block content %}

<div style="text-align:center;margin:32px 0 18px 0;">
    <!-- 賽事名稱美化 -->
    <div style="font-size:2em; font-weight:700; color:#726bff; margin-bottom:8px; letter-spacing:0.8px;">
        {{ game.tournament }}
    </div>
    <!-- 兩隊名字 -->
    <div style="font-size:2.1em; font-weight:700; margin-top:12px; letter-spacing:1.5px;">
        元智大學 <span style="font-size:1em; font-weight:500; color:#686;">vs</span>
        <span style="font-weight:900; color:#222;">{{ game.opponent }}</span>
    </div>    
    <!-- 比數 -->
    <div style="font-size:2.2em; font-weight:800; letter-spacing:1.5px;">
        {{ game.team_score }} : {{ game.opponent_score }}
    </div>
</div>

<hr style="margin-top:18px;">

<h2 style="text-align:center;">
    第 {{ inning }} 局{{ '上' if is_top else '下' }}｜出局數：{{ outs }}
</h2>
<h3 style="text-align:center;">
    目前投手：
</h3>
<h3 style="text-align:center;">
    {{ curr_pitcher.number if curr_pitcher else '?' }} - {{ curr_pitcher.name if curr_pitcher else '未指定' }}
</h3>

<br>
<form method="post" id="defense_form" 
onsubmit="document.getElementById('real_result').value = document.querySelector('select[name=result_select]').value;">
  <table style="margin:0 auto;">
    <tr>
      <td style="text-align:right;"><label>打席球員（對方）</label></td>
      <td><input name="batter_name" value="{{ last_batter_name }}"></td>
      <td style="text-align:right;"><label>打席結果：</label></td>
      <td colspan="3">
        <select name="result_select" required>
            <option value="三振">三振</option>
            <option value="四壞">四壞</option>
            <option value="觸身">觸身</option>
            <option value="內滾">內滾</option>
            <option value="內飛">內飛</option>
            <option value="犧牲">犧牲</option>
            <option value="外飛">外飛</option>
            <option value="雙殺">雙殺</option>
            <option value="內安">內安</option>
            <option value="一安">一安</option>
            <option value="二安">二安</option>
            <option value="三安">三安</option>
            <option value="全壘">全壘</option>
            <option value="失誤">失誤</option>
        </select>
      </td>
    </tr>
    <tr>
      <td style="text-align:right;"><label>好球：</label></td>
      <td>
        <div class="input-group">
          <button type="button" onclick="changeInput('strike',-1)">-</button>
          <input id="strike" name="strike" type="number" min="0" max="3" value="0" required>
          <button type="button" onclick="changeInput('strike',1)">+</button>
        </div>
      </td>
      <td style="text-align:right;"><label>壞球：</label></td>
      <td>
        <div class="input-group">
          <button type="button" onclick="changeInput('ball',-1)">-</button>
          <input id="ball" name="ball" type="number" min="0" max="4" value="0" required>
          <button type="button" onclick="changeInput('ball',1)">+</button>
        </div>
      </td>
    </tr>
    <tr>
      <td style="text-align:right;"><label>本打席投球：</label></td>
      <td>
        <div class="input-group">
          <button type="button" onclick="changeInput('pitch_count',-1)">-</button>
          <input id="pitch_count" name="pitch_count" type="number" min="0" value="0" required>
          <button type="button" onclick="changeInput('pitch_count',1)">+</button>
        </div>
      </td>
      <td style="text-align:right;"><label>失分：</label></td>
      <td>
        <div class="input-group">
          <button type="button" onclick="changeInput('runs',-1)">-</button>
          <input id="runs" name="runs" type="number" min="0" value="0">
          <button type="button" onclick="changeInput('runs',1)">+</button>
        </div>
      </td>
    </tr>
  </table>
  <input type="hidden" id="real_result" name="result" value="">
  <br>
    <!-- 按鈕群組區塊（整體置中） -->
    <div style="display: flex; flex-direction: column; align-items: center; gap: 18px; margin-top:40px;">
        <!-- 上方兩顆並排 -->
        <div style="display: flex; gap: 32px;">
            <button type="submit"
            style="padding:12px 32px; font-size:1.1em; border-radius:7px; background:#726bff; color:white; border:none; font-weight:600;">
            確定送出
        </button>
        <button type="button"
            onclick="document.getElementById('real_result').value = 'RUNNER_OUT'; document.getElementById('defense_form').submit();"
            style="padding:12px 32px; font-size:1.1em; border-radius:7px; background:#726bff; color:white; border:none; font-weight:600;">
            跑者出局
        </button>
    </div>
</form>

<!-- 換投手（單獨一行一顆） -->
<form action="{{ url_for('switch_pitcher', game_id=game_id, inning=inning) }}" method="get" style="margin:0;">
    <button type="submit"
    style="padding:12px 32px; font-size:1.1em; border-radius:7px; background:#726bff; color:white; border:none; font-weight:600;">
    換投手
    </button>
</form>
</div>

<div style="
    margin: 36px auto 0 auto; 
    display: flex; 
    justify-content: center;
    gap: 28px;
    flex-wrap: wrap;
    max-width: 650px;">
    <div style="background: #f7f7fb; border-radius: 9px; box-shadow:0px 2px 10px #eaeafd77; padding: 18px 28px; min-width:150px; margin-bottom:14px;">
        <div style="font-size:1.08em; color:#666; margin-bottom:7px; text-align:center;">{{ curr_pitcher.name if curr_pitcher else '' }} 本局投球數</div>
        <div style="font-size:1.7em; font-weight:700; color:#4d3eff; text-align:center; line-height:1.6;">
            {{ curr_pitcher_inning_pitch_count }}
        </div>
    </div>
    <div style="background: #f7f7fb; border-radius: 9px; box-shadow:0px 2px 10px #eaeafd77; padding: 18px 28px; min-width:150px; margin-bottom:14px;">
        <div style="font-size:1.08em; color:#666; margin-bottom:7px; text-align:center;">{{ curr_pitcher.name if curr_pitcher else '' }} 全場累計球數</div>
        <div style="font-size:1.7em; font-weight:700; color:#4d3eff; text-align:center; line-height:1.6;">
            {{ pitcher_pitch_count }}
        </div>
    </div>
    <div style="background: #f7f7fb; border-radius: 9px; box-shadow:0px 2px 10px #eaeafd77; padding: 18px 28px; min-width:150px; margin-bottom:14px;">
        <div style="font-size:1.08em; color:#666; margin-bottom:7px; text-align:center;">本局總球數</div>
        <div style="font-size:1.7em; font-weight:700; color:#4d3eff; text-align:center; line-height:1.6;">
            {{ total_pitch_this_inning }}
        </div>
    </div>
    <div style="background: #f7f7fb; border-radius: 9px; box-shadow:0px 2px 10px #eaeafd77; padding: 18px 28px; min-width:150px; margin-bottom:14px;">
        <div style="font-size:1.08em; color:#666; margin-bottom:7px; text-align:center;">全場總球數</div>
        <div style="font-size:1.7em; font-weight:700; color:#4d3eff; text-align:center; line-height:1.6;">
            {{ total_pitch_all }}
        </div>
    </div>
</div>

<table border="1" style="margin-top:16px;">
    <tr>
        <th>打席</th>
        <th>投手</th>
        <th>對方打者</th>
        <th>好球</th>
        <th>壞球</th>
        <th>投球數</th>
        <th>結果</th>
        <th>失分</th>
    </tr>
    {% for record in inning_records %}
    <tr>
        <td>{{ loop.index }}</td>
        <td>{{ record.pitcher.name if record.pitcher else '' }}</td>
        <td>{{ record.batter_name }}</td>
        <td>{{ record.strike }}</td>
        <td>{{ record.ball }}</td>
        <td>{{ record.pitch_count }}</td>
        <td>
            {% if record.result == 'RUNNER_OUT' %}
                跑者出局
            {% else %}
                {{ record.result }}
            {% endif %}
        </td>
        <td>{{ record.runs }}</td>
    </tr>
    {% endfor %}
</table>

{% if outs >= 3 %}
    <p style="color:blue;font-weight:bold;">三出局，自動進入進攻紀錄頁。</p>
    <script>
        setTimeout(function() {
            {% if is_top %}
                window.location = "{{ url_for('record_atbat', game_id=game_id, order=0, inning=inning) }}";
            {% else %}
                window.location = "{{ url_for('record_atbat', game_id=game_id, order=0, inning=inning+1) }}";
            {% endif %}
        }, 1200);
    </script>
{% endif %}

<div style="display:flex; justify-content:center; gap:30px; margin-top:26px;">
    <form action="{{ url_for('index') }}" style="margin:0;">
        <button type="submit"
            style="padding:12px 32px; font-size:1.08em; border-radius:9px; background:#726bff; color:white; border:none; font-weight:600;">
            返回首頁
        </button>
    </form>
    <form action="{{ url_for('finish_record', game_id=game_id) }}" method="post" style="margin:0;">
        <button type="submit"
            style="padding:12px 32px; font-size:1.08em; border-radius:9px; background:#2db966; color:white; border:none; font-weight:600;"onclick="return confirm('確定完成紀錄嗎？');">
            完成紀錄
        </button>
    </form>
</div>

<script>
function changeInput(id, delta) {
    let input = document.getElementById(id);
    let value = parseInt(input.value) || 0;
    let min = parseInt(input.min) || 0;
    let max = parseInt(input.max) || 9999;
    value += delta;
    if (value < min) value = min;
    if (value > max) value = max;
    input.value = value;
}
</script>

{% endblock %}
