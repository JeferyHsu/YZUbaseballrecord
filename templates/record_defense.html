<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>防守紀錄</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<h2>第 {{ inning }} 局{{ '上' if is_top else '下' }}｜出局數：{{ outs }}</h2>

<form method="post" id="defense_form">
    <input type="hidden" name="pitcher_id" value="{{ curr_pitcher_id }}">

    <p>目前投手：<strong>
        {% for p in pitchers %}
            {% if p.id == curr_pitcher_id %}{{ p.name }}{% endif %}
        {% endfor %}
    </strong></p>

    <label>打席球員（對方）</label>
    <input name="batter_name" value="{{ last_batter_name }}">

    <label>好球：</label>
    <input name="strike" type="number" min="0" max="3" value="0" required>

    <label>壞球：</label>
    <input name="ball" type="number" min="0" max="4" value="0" required>

    <label>本打席投球：</label>
    <input name="pitch_count" type="number" min="0" value="0" required>

    <label>打席結果：</label>
    <select name="result_select" required>
        <option value="三振">三振</option>
        <option value="四壞">四壞</option>
        <option value="觸身">觸身</option>
        <option value="內滾">內滾</option>
        <option value="內飛">內飛</option>
        <option value="犧牲">犧牲</option>
        <option value="外飛">外飛</option>
        <option value="雙殺">雙殺</option>
        <option value="內安">內安</option>
        <option value="一安">一安</option>
        <option value="二安">二安</option>
        <option value="三安">三安</option>
        <option value="全壘">全壘</option>
        <option value="失誤">失誤</option>
    </select>

    <label>失分：</label>
    <input name="runs" type="number" min="0" value="0">

    <!-- 隱藏欄位，真正送出的 result -->
    <input type="hidden" id="real_result" name="result" value="">

    <br><br>
    <button type="submit" onclick="
        // 送出時將下拉選單值填進隱藏欄位
        document.getElementById('real_result').value = document.querySelector('select[name=result_select]').value;
    ">確定送出</button>

    <button type="button" onclick="
        // 跑者出局按鈕，強制設定隱藏欄位為 RUNNER_OUT 並送出表單
        document.getElementById('real_result').value = 'RUNNER_OUT';
        document.getElementById('defense_form').submit();
    ">跑者出局</button>
</form>

<!-- 換投手按鈕，可跳轉換投手頁面 -->
<form action="{{ url_for('switch_pitcher', game_id=game_id, inning=inning) }}" method="get" style="display:inline;">
    <button type="submit">換投手</button>
</form>

<table border="1" style="margin-top:16px;">
    <tr>
        <th>打席</th>
        <th>投手</th>
        <th>對方打者</th>
        <th>好球</th>
        <th>壞球</th>
        <th>投球數</th>
        <th>結果</th>
        <th>失分</th>
    </tr>
    {% for record in inning_records %}
    <tr>
        <td>{{ loop.index }}</td>
        <td>{{ record.pitcher.name if record.pitcher else '' }}</td>
        <td>{{ record.batter_name }}</td>
        <td>{{ record.strike }}</td>
        <td>{{ record.ball }}</td>
        <td>{{ record.pitch_count }}</td>
        <td>
          {% if record.result == 'RUNNER_OUT' %}
            跑者出局
          {% else %}
            {{ record.result }}
          {% endif %}
        </td>
        <td>{{ record.runs }}</td>
    </tr>
    {% endfor %}
</table>

<p>本投手本局球數：{{ curr_pitcher_inning_pitch_count }}</p>
<p>本投手全場累計球數：{{ pitcher_pitch_count }}</p>
<p>本局總球數：{{ total_pitch_this_inning }}</p>
<p>全場總球數：{{ total_pitch_all }}</p>

{% if outs >= 3 %}
    <p style="color:blue;font-weight:bold;">三出局，自動進入進攻紀錄頁。</p>
    <script>
        setTimeout(function() {
            {% if is_top %}
                window.location = "{{ url_for('record_atbat', game_id=game_id, order=0, inning=inning) }}";
            {% else %}
                window.location = "{{ url_for('record_atbat', game_id=game_id, order=0, inning=inning+1) }}";
            {% endif %}
        }, 1200);
    </script>
{% endif %}

<form action="{{ url_for('index') }}" style="display:inline;">
    <button type="submit">返回首頁</button>
</form>

<form action="{{ url_for('finish_record', game_id=game_id) }}" method="post">
    <button type="submit" style="background:#28a745;color:white;font-size:16px;">完成紀錄</button>
</form>

</body>
</html>
